<!DOCTYPE html>
<html>
<head>
  <title>Test</title>

  <script src="./vendor/require.js"></script>
  <script src="./config.js"></script>

  <script type="text/javascript">
    (function(){
      // pull config from querystring
      var expectedKeys = { location: true };

      function populate(queryStr, config) {
        var pairs, nameValue;
        pairs = queryStr.split('&');
        for(var i=0; i<pairs.length; i++) {
          nameValue = pairs[i].split('=');
          if(nameValue[0] && (nameValue[0] in expectedKeys)){
            config[ nameValue[0] ] = nameValue[1];
          }
        }
      }
      var queryStr = location.search.substring(1);
      if(queryStr){
        populate(queryStr, config)
      }
    })();

    var locn = config.location || 'test/3,3';
    require([
      'knockout', 
      'lib/util', 
      'plugins/resource!location/'+locn
    ],function(ko, util, tile) {
      //run tests
      tile.regionId = 'test';
      console.log("Loaded location tile: ", tile);

      function makeObservable(obj) {
        var vm = {};
        Object.keys(obj).forEach(function(name) {
          vm[name] = (obj[name] instanceof Array) ? ko.observableArray(obj[name]) : obj[name];
        });
        return vm;
      }

      var viewModel = window.viewModel =  {
        editMode: ko.observable( location.hash.indexOf('edit')>-1 ), 
        tile: makeObservable(tile)
      };
      console.log("Prepared viewMode: ", viewModel);
      ko.applyBindings(viewModel);

      window.onhashchange = function(evt){
        viewModel.editMode( location.hash.indexOf('edit')>-1 );
      };

    });
  </script>
</head>

<body>

  <div class="panel" data-bind="visible: !editMode()">
    Preview Panel
    <section id="main" data-bind="with: tile">
      <h2>Location: <span data-bind="text: id"></span></h2>
      <dl>
        <dt>Region:</dt>
        <dd data-bind="text: regionId"></dd>
        <dt>Terrain:</dt>
        <dd data-bind="text: terrain"></dd>
        <dt>Description:</dt>
        <dd data-bind="text: description"></dd>
      </dl>
      <h2>Here</h2>
      
      <ul data-bind="foreach: here">
        <li><span data-bind="text: name"></span> (<span data-bind="text: type"></span>)</li>
      </ul>

      <h2>Encounters</h2>
      <ul data-bind="foreach: encounters">
        <li><span data-bind="text: name"></span> (<span data-bind="text: type"></span>)</li>
      </ul>

    </section>  
  </div>

  <div class="panel" data-bind="visible: editMode">
    Edit Panel
    <section id="editor" data-bind="with: tile">
      <h2>Location: <span data-bind="text: id"></span></h2>
      <dl>
        <dt>Region:</dt>
        <dd data-bind="text: regionId"></dd>
        <dt>Terrain:</dt>
        <dd><input type="text" data-bind="value: terrain"></dd>
        <dt>Description:</dt>
        <dd><textarea data-bind="value: description"></textarea></dd>
      </dl>
      <h2>Here</h2>
      
      <ul data-bind="foreach: here">
        <li><span data-bind="text: name"></span> (<span data-bind="text: type"></span>)</li>
      </ul>
      <h2>Encounters</h2>
      <ul data-bind="foreach: encounters">
        <li><span data-bind="text: name"></span> (<span data-bind="text: type"></span>)</li>
      </ul>
    </section>  
  </div>

</body>
</html>
